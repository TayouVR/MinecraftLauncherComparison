---
import Layout from '../layouts/Layout.astro';

import json5 from 'json5';
import { readFileSync, readdirSync } from 'fs';
import path from 'path';
import ListComponent from "../components/ListComponent.astro";

function getLauncherDetails(path: string) {
	return json5.parse<LauncherDetails>(
		readFileSync(path, 'utf-8')
	);
}


const dataDir = './src/launcher-definitions'; // Define the directory that holds JSON5 files
const launchers: LauncherDetails[] = [];

// Dynamically loop through all files in the directory
readdirSync(dataDir).forEach((file) => {
	if (file.endsWith('.json5')) {
		const filePath = path.join(dataDir, file); // Construct full file path
		launchers.push(getLauncherDetails(filePath)); // Parse and push to `launchers`
	}
});

function launcherProperties<TLauncher extends Record<string, any>>(
	launchers: LauncherDetails[],
	sections: (keyof TLauncher)[]
): Array<{ name: string; values: Array<{ identifier: string; value: unknown }>; }> {
	// Create a map to group properties by name
	const grouped: Record<string, { name: string; values: Array<{ identifier: string; value: unknown }>; }> = {};

	// Iterate over each launcher
	(launchers as any as TLauncher[]).forEach((launcher) => {
		sections.forEach((section) => {
			// console.log(`\nSection: ${String(section)}`);
			const fields = launcher[section];

			Object.entries(fields).forEach(([fieldName, fieldValue]) => {
				// console.log(`Field Name: ${fieldName}`);
				// console.log("Field Value:", fieldValue);
				if (!grouped[fieldName]) {
					// If the `name` doesn't exist in the grouped map, initialize it
					grouped[fieldName] = { name: fieldName, values: [] };
				}
				// Add the launcher identifier and its property value
				grouped[fieldName].values.push({
					identifier: launcher.identifier,
					value: fieldValue,
				});
			});
		});
	});

	// Convert the grouped entries back into an array
	return Object.values(grouped);
}


const columnsClientState: any = {};
launchers.forEach((launcher) => {
	columnsClientState[launcher.identifier] = { enabled: true };
});
---

<Layout>
	<clientData id="clientData" value={JSON.stringify(columnsClientState)}></clientData>

	This will give you an overview over the various Minecraft (Java Edition) launchers and their features.<br>
	<br>
	Explanations:
	<ul>
		<li>Modloader support means a way to install the modloader through the launcher directly, without downloading it separately.</li>
		<li>CurseForge blocked downloads: CurseForge offers creators on the platform the option to opt out of downloads from 3rd party platforms as a means to ensure ad revenue is generated when downloading content. Platforms need to work around that restriction to properly support CurseForge content.</li>
	</ul>

	Note: This list is maintained mostly by me and random contributions. Data will inevitably get outdated over time and I always welcome any updates and corrections.<br>

	<!-- change popover-1 and --anchor-1 names. Use unique names for each dropdown -->
	<button class="btn" popovertarget="popover-1" style="anchor-name:--anchor-1">
		Launcher Selection
	</button>
	<ul class="dropdown menu w-52 rounded-box bg-base-100 shadow-sm"
		popover id="popover-1" style="position-anchor:--anchor-1">
		{ launchers.map(launcher => (
			<li class:list={["launcher-toggle", launcher.identifier]}><a onclick={`toggleVisibility('${launcher.identifier}')`} class="flex items-center gap-2">
				{ launcher.icon ? (
					<img class="w-8 h-8" src={launcher.icon}  alt=`${launcher.name} Icon` />
				) : ""}
				<span>{launcher.name}</span>
			</a></li>
		))}
	</ul>
	<div class="launcher-toggle-container">
		{ launchers.map(launcher => (
			<button class:list={["launcher-toggle", "btn", launcher.identifier, "size-30"]} onclick={`toggleVisibility('${launcher.identifier}')`}>
				{ launcher.icon ? (
					<img class="w-full h-full object-contain" src={launcher.icon}  alt=`${launcher.name} Icon` />
				) : launcher.name}
			</button>
		))}
	</div>

	<div class="table-container w-full overflow-auto">
	<table class="table table-zebra table-hover table-bordered w-full">
		<thead class="sticky top-0 z-10 bg-base-100 shadow-sm">
			<tr class="header-row">
				<th class="bg-base-100">Feature</th>
				{ launchers.map(launcher => (
					<th class:list={[launcher.identifier, "bg-base-100"]}>
						<a href={`/launcher/${launcher.identifier}`} class="flex flex-col items-center gap-2 hover:bg-base-200 p-2 rounded-lg transition-colors h-full w-full justify-center">
							{ launcher.icon ? (
								<img class="launcher-icon w-16 h-16 object-contain" src={launcher.icon}  alt=`${launcher.name} Icon` />
							) : <div class="w-16 h-16 flex items-center justify-center font-bold">?</div>}
							<span class="text-center">{launcher.name}</span>
						</a>
					</th>
				))}
			</tr>
		</thead>
		<tbody>
			<tr>
				<th>License</th>
				{ launchers.map(launcher => (
					<td>
						<div class:list={[launcher.identifier, launcher.configuration.license.foss ? "yes" : "no", "badge"]}>
							{launcher.configuration.license.name}
						</div>
					</td>
				))}
			</tr>
			<tr>
				<th>Look & Feel</th>
				{ launchers.map(launcher => (
					<th class={launcher.identifier}>{launcher.configuration.lookAndFeel}</th>
				))}
			</tr>
			{ launcherProperties(launchers, ["properties"])
				.filter((prop) => prop.name != "packages")
				.map((property) => (
				<ListComponent propertyName={property.name} launchers={launchers} propCategory="properties" />
			))}
			{ launcherProperties(launchers, ["features"]).map((property) => (
				<ListComponent propertyName={property.name} launchers={launchers} propCategory="features" />
			))}
            <tr>
                <th>CurseForge Blocked Mods handling</th>
                { launchers.map(launcher => (
                        <th class:list={[launcher.identifier, launcher.specialFeatures.CurseForgeBlockedDownloads.supported ? "yes" : "no"]}>
                            {launcher.specialFeatures.CurseForgeBlockedDownloads.method != "" ? launcher.specialFeatures.CurseForgeBlockedDownloads.method : "No"}
                        </th>
                ))}
            </tr>
		</tbody>
	</table>
	</div>
</Layout>

<script is:inline>

	let columns = {};

	function getColumns() {
		if (Object.keys(columns).length === 0) {
			const jsonString = document.getElementById("clientData").attributes.value.value;
			columns = JSON.parse(jsonString);
		}
		return columns;
	}

	// JavaScript function to toggle visibility
	function toggleVisibility(className) {
		getColumns();
		const elements = document.getElementsByClassName(className);
		columns[className].enabled = !columns[className].enabled;
		for (const element of elements) {
			// Toggle between visible and hidden
			if (columns[className].enabled === element.classList.contains("column-disabled")) {
				element.classList.toggle("column-disabled");
			}
		}
	}
</script>